<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>JeetLo Factory</title>
  <link rel="manifest" href="manifest.json">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      min-height: 100vh;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid #333;
      flex-wrap: wrap;
      gap: 10px;
    }
    h1 { color: #4CAF50; font-size: 24px; }
    .header-actions { display: flex; gap: 10px; }
    .btn-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: #1a1a1a;
      color: #888;
      cursor: pointer;
      font-size: 18px;
    }
    .btn-icon:hover { background: #333; color: #fff; }
    @media (max-width: 768px) {
      .stats { display: none; }
      .tabs { flex-wrap: wrap; }
      .reels-grid { grid-template-columns: 1fr; }
      .create-form { padding: 15px; }
    }
    .stats {
      display: flex;
      gap: 20px;
    }
    .stat {
      text-align: center;
      padding: 10px 20px;
      background: #1a1a1a;
      border-radius: 8px;
    }
    .stat-value { font-size: 28px; font-weight: bold; color: #4CAF50; }
    .stat-label { font-size: 12px; color: #888; }

    .tabs {
      display: flex;
      gap: 10px;
      margin: 20px 0;
    }
    .tab {
      padding: 10px 20px;
      background: #1a1a1a;
      border: none;
      color: #888;
      border-radius: 8px;
      cursor: pointer;
    }
    .tab.active { background: #4CAF50; color: #000; }

    .panel { display: none; }
    .panel.active { display: block; }

    /* Reels Grid */
    .reels-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .reel-card {
      background: #1a1a1a;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #333;
    }
    .reel-header {
      padding: 15px;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .reel-id { font-weight: bold; color: #fff; }
    .reel-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .status-posted { background: #4CAF50; color: #000; }
    .status-pending { background: #FF9800; color: #000; }
    .status-failed { background: #F44336; color: #fff; }
    .reel-body { padding: 15px; }
    .reel-topic { color: #ccc; margin-bottom: 10px; }
    .reel-meta { font-size: 12px; color: #666; }
    .subject-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-right: 8px;
    }
    .subject-biology { background: #CC66FF; color: #000; }
    .subject-chemistry { background: #00CC66; color: #000; }
    .subject-physics { background: #0066FF; color: #fff; }
    .subject-mathematics { background: #FF9900; color: #000; }

    /* Create Form */
    .create-form {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
    }
    .form-group { margin-bottom: 20px; }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #888;
      font-size: 14px;
    }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 12px;
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
    }
    .form-group textarea { min-height: 100px; resize: vertical; }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }
    .btn-primary { background: #4CAF50; color: #000; }
    .btn-secondary { background: #333; color: #fff; }

    /* Primitives */
    .primitives-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }
    .primitive-card {
      background: #1a1a1a;
      border-radius: 8px;
      padding: 15px;
      border: 1px solid #333;
    }
    .primitive-name { color: #4CAF50; font-weight: bold; margin-bottom: 5px; }
    .primitive-methods { font-size: 12px; color: #666; }

    /* Pipeline Status */
    .pipeline {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 20px;
      font-family: monospace;
    }
    .pipeline-step {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid #333;
    }
    .step-icon { font-size: 20px; }
    .step-name { color: #fff; }
    .step-status { margin-left: auto; }

    /* Chat */
    .chat-container {
      background: #1a1a1a;
      border-radius: 12px;
      height: 500px;
      display: flex;
      flex-direction: column;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    .chat-input {
      display: flex;
      padding: 15px;
      border-top: 1px solid #333;
    }
    .chat-input input {
      flex: 1;
      padding: 12px;
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 8px;
      color: #fff;
    }
    .message {
      margin-bottom: 15px;
      padding: 12px;
      border-radius: 8px;
    }
    .message-user { background: #333; margin-left: 50px; }
    .message-claude { background: #1e3a1e; margin-right: 50px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>JeetLo Factory</h1>
      <div class="header-actions">
        <button class="btn-icon" onclick="setGitHubToken()" title="Settings">&#9881;</button>
        <a href="https://github.com/pdaxt/jeetlo-factory/actions" target="_blank" class="btn-icon" title="GitHub Actions">&#9889;</a>
      </div>
      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="total-reels">0</div>
          <div class="stat-label">Total Reels</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="posted-reels">0</div>
          <div class="stat-label">Posted</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="pending-reels">0</div>
          <div class="stat-label">Pending</div>
        </div>
      </div>
    </header>

    <div class="tabs">
      <button class="tab active" data-panel="reels">Reels</button>
      <button class="tab" data-panel="create">Create New</button>
      <button class="tab" data-panel="primitives">Primitives</button>
      <button class="tab" data-panel="pipeline">Pipeline</button>
      <button class="tab" data-panel="chat">Chat with Claude</button>
    </div>

    <!-- Reels Panel -->
    <div id="reels" class="panel active">
      <div class="reels-grid" id="reels-grid"></div>
    </div>

    <!-- Create Panel -->
    <div id="create" class="panel">
      <div class="create-form">
        <h2 style="margin-bottom: 20px; color: #fff;">Create New Reel</h2>
        <form id="create-form">
          <div class="form-group">
            <label>Subject</label>
            <select name="subject" id="subject-select">
              <option value="biology">Biology</option>
              <option value="chemistry">Chemistry</option>
              <option value="physics">Physics</option>
              <option value="mathematics">Mathematics</option>
            </select>
          </div>
          <div class="form-group">
            <label>Reel ID (auto-generated)</label>
            <input type="text" name="reel_id" id="reel-id" readonly>
          </div>
          <div class="form-group">
            <label>Topic</label>
            <textarea name="topic" placeholder="What is this reel about?"></textarea>
          </div>
          <div class="form-group">
            <label>Hook</label>
            <input type="text" name="hook" placeholder="Attention-grabbing opening question">
          </div>
          <div class="form-group">
            <label>Key Fact</label>
            <textarea name="key_fact" placeholder="The main scientific fact to teach"></textarea>
          </div>
          <div class="form-group">
            <label>Why It Matters</label>
            <input type="text" name="why_it_matters" placeholder="Why should students care?">
          </div>
          <div class="form-group">
            <label>Exam Relevance</label>
            <input type="text" name="exam_relevance" placeholder="How this appears in JEE/NEET">
          </div>
          <button type="submit" class="btn btn-primary">Create Reel Request</button>
        </form>
      </div>
    </div>

    <!-- Primitives Panel -->
    <div id="primitives" class="panel">
      <h2 style="margin-bottom: 20px; color: #fff;">manim-edu Primitives</h2>
      <div class="primitives-list" id="primitives-list"></div>
    </div>

    <!-- Pipeline Panel -->
    <div id="pipeline" class="panel">
      <h2 style="margin-bottom: 20px; color: #fff;">Pipeline Status</h2>
      <div class="pipeline">
        <div class="pipeline-step">
          <span class="step-icon">1</span>
          <span class="step-name">SCRIPT - Write segment scripts</span>
          <span class="step-status">-</span>
        </div>
        <div class="pipeline-step">
          <span class="step-icon">2</span>
          <span class="step-name">AUDIO - Generate TTS audio</span>
          <span class="step-status">-</span>
        </div>
        <div class="pipeline-step">
          <span class="step-icon">3</span>
          <span class="step-name">VIDEO - Render Manim animation</span>
          <span class="step-status">-</span>
        </div>
        <div class="pipeline-step">
          <span class="step-icon">4</span>
          <span class="step-name">COMBINE - Merge audio + video</span>
          <span class="step-status">-</span>
        </div>
        <div class="pipeline-step">
          <span class="step-icon">5</span>
          <span class="step-name">VALIDATE - Run QA checks</span>
          <span class="step-status">-</span>
        </div>
        <div class="pipeline-step">
          <span class="step-icon">6</span>
          <span class="step-name">POST - Post to platforms</span>
          <span class="step-status">-</span>
        </div>
      </div>
    </div>

    <!-- Chat Panel -->
    <div id="chat" class="panel">
      <h2 style="margin-bottom: 20px; color: #fff;">Chat with Claude</h2>
      <div class="chat-container">
        <div class="chat-messages" id="chat-messages">
          <div class="message message-claude">
            Hi! I'm Claude. I can help you create JeetLo reels. What would you like to create?
          </div>
        </div>
        <div class="chat-input">
          <input type="text" id="chat-input" placeholder="Ask Claude anything...">
          <button class="btn btn-primary" style="margin-left: 10px;" onclick="sendMessage()">Send</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.panel).classList.add('active');
      });
    });

    // Load data
    let reelsData = null;
    let primitivesData = null;

    async function loadData() {
      try {
        const reelsRes = await fetch('../db/reels.json');
        reelsData = await reelsRes.json();

        const primRes = await fetch('../db/primitives.json');
        primitivesData = await primRes.json();

        renderReels();
        renderPrimitives();
        updateStats();
        updateReelId();
      } catch (e) {
        console.error('Error loading data:', e);
      }
    }

    function renderReels() {
      const grid = document.getElementById('reels-grid');
      grid.innerHTML = reelsData.reels.map(reel => `
        <div class="reel-card">
          <div class="reel-header">
            <span class="reel-id">${reel.reel_id}</span>
            <span class="reel-status status-${reel.status}">${reel.status}</span>
          </div>
          <div class="reel-body">
            <div class="reel-topic">${reel.topic}</div>
            <div class="reel-meta">
              <span class="subject-badge subject-${reel.subject}">${reel.subject}</span>
              ${reel.posted_at ? `Posted: ${new Date(reel.posted_at).toLocaleDateString()}` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderPrimitives() {
      const list = document.getElementById('primitives-list');
      let html = '';
      for (const [category, items] of Object.entries(primitivesData.available)) {
        for (const [name, info] of Object.entries(items)) {
          html += `
            <div class="primitive-card">
              <div class="primitive-name">${name}</div>
              <div class="primitive-methods">${info.description || ''}</div>
              ${info.methods ? `<div class="primitive-methods">Methods: ${info.methods.join(', ')}</div>` : ''}
            </div>
          `;
        }
      }
      list.innerHTML = html;
    }

    function updateStats() {
      document.getElementById('total-reels').textContent = reelsData.reels.length;
      document.getElementById('posted-reels').textContent =
        reelsData.reels.filter(r => r.status === 'posted').length;
      document.getElementById('pending-reels').textContent =
        reelsData.reels.filter(r => r.status !== 'posted').length;
    }

    function updateReelId() {
      const subject = document.getElementById('subject-select').value;
      const nextNum = (reelsData.counters[subject] || 0) + 1;
      const prefix = subject.substring(0, 3);
      document.getElementById('reel-id').value = `${prefix}-${String(nextNum).padStart(2, '0')}-`;
    }

    document.getElementById('subject-select').addEventListener('change', updateReelId);

    // GitHub token for triggering workflows (you'll need to set this)
    const GITHUB_TOKEN = localStorage.getItem('github_token') || '';
    const REPO = 'pdaxt/jeetlo-factory';

    document.getElementById('create-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);

      const reelId = data.reel_id + data.topic.toLowerCase().replace(/[^a-z0-9]+/g, '-').substring(0, 30);

      // Create request object
      const request = {
        reel_id: reelId,
        subject: data.subject,
        topic: data.topic,
        hook: data.hook,
        key_fact: data.key_fact,
        why_it_matters: data.why_it_matters,
        exam_relevance: data.exam_relevance,
        cta: "Follow for more!",
        style: {
          tone: "curious and engaging",
          language: "hinglish",
          target_duration_seconds: 45
        }
      };

      console.log('Creating request:', request);

      // Try to trigger GitHub workflow
      if (GITHUB_TOKEN) {
        try {
          const res = await fetch(`https://api.github.com/repos/${REPO}/dispatches`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${GITHUB_TOKEN}`,
              'Accept': 'application/vnd.github.v3+json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              event_type: 'create-reel',
              client_payload: request
            })
          });

          if (res.ok || res.status === 204) {
            alert(`Reel request created!\n\nReel ID: ${reelId}\n\nPipeline triggered on GitHub Actions.`);
            window.open(`https://github.com/${REPO}/actions`, '_blank');
          } else {
            throw new Error(`GitHub API error: ${res.status}`);
          }
        } catch (err) {
          console.error('Failed to trigger workflow:', err);
          alert(`Request created but couldn't trigger workflow.\n\nYou can manually trigger it:\n1. Go to GitHub Actions\n2. Select "Create JeetLo Reel"\n3. Enter reel_id: ${reelId}`);
        }
      } else {
        // No token - show instructions
        const action = confirm(`Request created!\n\nReel ID: ${reelId}\n\nClick OK to open GitHub Actions and trigger manually.`);
        if (action) {
          window.open(`https://github.com/${REPO}/actions/workflows/create-reel.yml`, '_blank');
        }
      }
    });

    // Settings for GitHub token
    function setGitHubToken() {
      const token = prompt('Enter your GitHub Personal Access Token (for triggering workflows):');
      if (token) {
        localStorage.setItem('github_token', token);
        alert('Token saved! You can now trigger workflows from this dashboard.');
      }
    }

    function sendMessage() {
      const input = document.getElementById('chat-input');
      const messages = document.getElementById('chat-messages');
      const text = input.value.trim();
      if (!text) return;

      messages.innerHTML += `<div class="message message-user">${text}</div>`;
      input.value = '';

      // In a real implementation, this would call Claude CLI
      // For now, show a placeholder response
      setTimeout(() => {
        messages.innerHTML += `<div class="message message-claude">
          I understand you want to create content about "${text}".
          Let me help you structure this as a JeetLo reel.
          Go to the "Create New" tab to fill in the details!
        </div>`;
        messages.scrollTop = messages.scrollHeight;
      }, 1000);
    }

    document.getElementById('chat-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    loadData();
  </script>
</body>
</html>
