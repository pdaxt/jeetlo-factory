name: Create JeetLo Reel

# ═══════════════════════════════════════════════════════════════════════════════
# JEETLO REEL CREATION PIPELINE
# ═══════════════════════════════════════════════════════════════════════════════
#
# This pipeline creates a complete JeetLo reel from a request file.
#
# TRUST MODEL:
# - Each step runs as a SEPARATE, ISOLATED job
# - Steps only receive the outputs from previous steps
# - The workflow file defines ALL instructions (auditable in Git)
# - Cryptographic hashes link each step to the previous
#
# STEPS:
# 1. SCRIPT   - Claude writes the segment scripts (Hinglish)
# 2. AUDIO    - Google TTS generates audio files
# 3. VIDEO    - Manim renders the animation
# 4. COMBINE  - FFmpeg merges audio + video
# 5. VALIDATE - All QA checks run
# 6. POST     - Post to Instagram + YouTube
#
# ═══════════════════════════════════════════════════════════════════════════════

on:
  push:
    paths:
      - 'requests/*.json'
      - '!requests/_template.json'
      - '!requests/README.md'
  workflow_dispatch:
    inputs:
      request_file:
        description: 'Request file name (e.g., bio-06-topic.json)'
        required: true
        type: string

env:
  REQUEST_FILE: ${{ github.event.inputs.request_file || '' }}

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # STEP 0: DETECT - Find the request file
  # ═══════════════════════════════════════════════════════════════════════════
  detect:
    name: "0 Detect Request"
    runs-on: ubuntu-latest
    outputs:
      request_file: ${{ steps.find.outputs.request_file }}
      reel_id: ${{ steps.find.outputs.reel_id }}
      subject: ${{ steps.find.outputs.subject }}
      request_json: ${{ steps.find.outputs.request_json }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Find request file
        id: find
        run: |
          # If manually triggered, use the input
          if [ -n "${{ env.REQUEST_FILE }}" ]; then
            REQUEST="requests/${{ env.REQUEST_FILE }}"
          else
            # Find the changed request file
            REQUEST=$(git diff --name-only HEAD~1 HEAD | grep '^requests/.*\.json$' | grep -v '_template.json' | head -1)
          fi

          if [ -z "$REQUEST" ] || [ ! -f "$REQUEST" ]; then
            echo "No request file found"
            exit 1
          fi

          echo "Found request: $REQUEST"

          # Extract fields
          REEL_ID=$(jq -r '.reel_id' "$REQUEST")
          SUBJECT=$(jq -r '.subject' "$REQUEST")
          REQUEST_JSON=$(cat "$REQUEST" | base64 -w 0)

          echo "request_file=$REQUEST" >> $GITHUB_OUTPUT
          echo "reel_id=$REEL_ID" >> $GITHUB_OUTPUT
          echo "subject=$SUBJECT" >> $GITHUB_OUTPUT
          echo "request_json=$REQUEST_JSON" >> $GITHUB_OUTPUT

          echo "## Request Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Reel ID:** \`$REEL_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Subject:** \`$SUBJECT\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Request Content" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat "$REQUEST" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ═══════════════════════════════════════════════════════════════════════════
  # STEP 1: SCRIPT - Claude writes the segment scripts
  # ═══════════════════════════════════════════════════════════════════════════
  script:
    name: "1 Write Script"
    needs: detect
    runs-on: ubuntu-latest
    outputs:
      segments_json: ${{ steps.write.outputs.segments_json }}
      output_hash: ${{ steps.write.outputs.output_hash }}
    steps:
      - name: Write script
        id: write
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "## Step 1: SCRIPT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **ROLE:** I am the SCRIPT WRITER. I write engaging Hinglish scripts." >> $GITHUB_STEP_SUMMARY
          echo "> **INPUT:** The reel request (topic, hook, key fact)." >> $GITHUB_STEP_SUMMARY
          echo "> **OUTPUT:** Segment scripts with text for TTS." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Decode request
          echo "${{ needs.detect.outputs.request_json }}" | base64 -d > request.json

          TOPIC=$(jq -r '.topic' request.json)
          HOOK=$(jq -r '.hook' request.json)
          KEY_FACT=$(jq -r '.key_fact' request.json)
          WHY_MATTERS=$(jq -r '.why_it_matters' request.json)
          EXAM_REL=$(jq -r '.exam_relevance' request.json)
          CTA=$(jq -r '.cta' request.json)
          SUBJECT=$(jq -r '.subject' request.json)

          # Call Claude to write the script
          cat > prompt.txt << 'PROMPT_END'
          You are a JeetLo script writer. Write a 45-second Hinglish reel script.

          RULES:
          - Use Devanagari for Hindi words (भाई not bhai)
          - Use English for technical terms (angle, DNA, etc.)
          - Numbers in English (forty two, not बयालीस)
          - Greek letters in Devanagari (थीटा for theta)
          - Add emotion: CAPS for emphasis, ... for pauses, ! for energy

          OUTPUT FORMAT (JSON only, no explanation):
          {
            "segments": [
              {"id": "01_hook", "text": "Hook text here..."},
              {"id": "02_setup", "text": "Setup text..."},
              {"id": "03_explain", "text": "Explanation..."},
              {"id": "04_fact", "text": "Key fact..."},
              {"id": "05_why", "text": "Why it matters..."},
              {"id": "06_exam", "text": "Exam relevance..."},
              {"id": "07_cta", "text": "Call to action..."}
            ]
          }
          PROMPT_END

          # Create the API request
          PROMPT=$(cat prompt.txt)

          cat > api_request.json << EOF
          {
            "model": "claude-sonnet-4-20250514",
            "max_tokens": 2000,
            "messages": [{
              "role": "user",
              "content": "Write a JeetLo reel script about:\n\nTOPIC: ${TOPIC}\nHOOK: ${HOOK}\nKEY FACT: ${KEY_FACT}\nWHY IT MATTERS: ${WHY_MATTERS}\nEXAM RELEVANCE: ${EXAM_REL}\nCTA: ${CTA}\n\n${PROMPT}"
            }]
          }
          EOF

          # Call Claude API
          curl -s -X POST https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d @api_request.json > response.json

          # Extract the script
          jq -r '.content[0].text' response.json > script_raw.txt

          # Parse JSON from response (handle markdown code blocks)
          grep -v '```' script_raw.txt | jq '.' > segments.json 2>/dev/null || {
            # If that fails, try to extract JSON directly
            cat script_raw.txt | sed -n '/^{/,/^}/p' | jq '.' > segments.json
          }

          # Validate we have segments
          SEGMENT_COUNT=$(jq '.segments | length' segments.json)
          if [ "$SEGMENT_COUNT" -lt 3 ]; then
            echo "Error: Not enough segments generated"
            exit 1
          fi

          # Generate output hash
          OUTPUT_HASH=$(sha256sum segments.json | cut -d' ' -f1)

          # Output for next step
          SEGMENTS_B64=$(cat segments.json | base64 -w 0)
          echo "segments_json=$SEGMENTS_B64" >> $GITHUB_OUTPUT
          echo "output_hash=$OUTPUT_HASH" >> $GITHUB_OUTPUT

          echo "### Script Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Segments:** $SEGMENT_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "**Output Hash:** \`${OUTPUT_HASH:0:16}...\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat segments.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ═══════════════════════════════════════════════════════════════════════════
  # STEP 2: AUDIO - Generate TTS audio
  # ═══════════════════════════════════════════════════════════════════════════
  audio:
    name: "2 Generate Audio"
    needs: [detect, script]
    runs-on: ubuntu-latest
    outputs:
      timings_json: ${{ steps.generate.outputs.timings_json }}
      audio_hash: ${{ steps.generate.outputs.audio_hash }}
      input_hash: ${{ steps.generate.outputs.input_hash }}
    steps:
      - name: Setup
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Generate audio
        id: generate
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_TTS_CREDENTIALS }}
        run: |
          echo "## Step 2: AUDIO" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **ROLE:** I am the AUDIO GENERATOR. I convert text to speech." >> $GITHUB_STEP_SUMMARY
          echo "> **INPUT:** Segment scripts from Step 1." >> $GITHUB_STEP_SUMMARY
          echo "> **OUTPUT:** MP3 audio files + timings.json." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Decode segments
          echo "${{ needs.script.outputs.segments_json }}" | base64 -d > segments.json

          # Verify chain
          INPUT_HASH=$(sha256sum segments.json | cut -d' ' -f1)
          EXPECTED_HASH="${{ needs.script.outputs.output_hash }}"

          echo "### Chain Validation" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "Expected input hash: ${EXPECTED_HASH:0:32}..." >> $GITHUB_STEP_SUMMARY
          echo "Actual input hash:   ${INPUT_HASH:0:32}..." >> $GITHUB_STEP_SUMMARY

          if [ "$INPUT_HASH" != "$EXPECTED_HASH" ]; then
            echo "STATUS: CHAIN BROKEN" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "## PIPELINE HALTED - CHAIN INTEGRITY VIOLATED" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "STATUS: CHAIN VALID" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Setup Google credentials
          echo "$GOOGLE_APPLICATION_CREDENTIALS_JSON" > /tmp/gcloud-creds.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcloud-creds.json

          # Get subject-specific voice
          SUBJECT="${{ needs.detect.outputs.subject }}"
          case "$SUBJECT" in
            physics) VOICE="hi-IN-Chirp3-HD-Orus" ;;
            chemistry) VOICE="hi-IN-Chirp3-HD-Fenrir" ;;
            biology) VOICE="hi-IN-Chirp3-HD-Leda" ;;
            mathematics) VOICE="hi-IN-Chirp3-HD-Kore" ;;
            *) VOICE="hi-IN-Chirp3-HD-Fenrir" ;;
          esac

          mkdir -p audio
          TIMINGS="[]"
          CUMULATIVE=0

          # Generate audio for each segment
          for row in $(jq -c '.segments[]' segments.json); do
            ID=$(echo $row | jq -r '.id')
            TEXT=$(echo $row | jq -r '.text')

            echo "Generating: $ID"

            # Call Google TTS API
            cat > tts_request.json << EOF
          {
            "input": {"text": "$TEXT"},
            "voice": {"languageCode": "hi-IN", "name": "$VOICE"},
            "audioConfig": {"audioEncoding": "MP3", "speakingRate": 0.95}
          }
          EOF

            curl -s -X POST \
              -H "Authorization: Bearer $(gcloud auth print-access-token)" \
              -H "Content-Type: application/json" \
              "https://texttospeech.googleapis.com/v1/text:synthesize" \
              -d @tts_request.json > tts_response.json

            # Decode audio
            jq -r '.audioContent' tts_response.json | base64 -d > "audio/${ID}.mp3"

            # Get duration
            DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "audio/${ID}.mp3")

            # Add to timings
            TIMINGS=$(echo "$TIMINGS" | jq --arg id "$ID" --arg text "$TEXT" \
              --argjson dur "$DURATION" --argjson start "$CUMULATIVE" \
              '. += [{"id": $id, "text": $text, "duration": $dur, "startTime": $start, "endTime": ($start + $dur)}]')

            CUMULATIVE=$(echo "$CUMULATIVE + $DURATION" | bc)
          done

          echo "$TIMINGS" > audio/timings.json

          # Combine audio
          for f in audio/*.mp3; do echo "file '$(basename $f)'" >> audio/concat.txt; done
          ffmpeg -y -f concat -safe 0 -i audio/concat.txt -c copy audio/combined_audio.mp3

          # Calculate hash
          AUDIO_HASH=$(find audio -name "*.mp3" -exec sha256sum {} \; | sort | sha256sum | cut -d' ' -f1)

          # Output
          TIMINGS_B64=$(cat audio/timings.json | base64 -w 0)
          echo "timings_json=$TIMINGS_B64" >> $GITHUB_OUTPUT
          echo "audio_hash=$AUDIO_HASH" >> $GITHUB_OUTPUT
          echo "input_hash=$INPUT_HASH" >> $GITHUB_OUTPUT

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Audio Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Voice:** $VOICE" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Duration:** ${CUMULATIVE}s" >> $GITHUB_STEP_SUMMARY
          echo "- **Output Hash:** \`${AUDIO_HASH:0:16}...\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload audio artifacts
        uses: actions/upload-artifact@v4
        with:
          name: audio-${{ needs.detect.outputs.reel_id }}
          path: audio/

  # ═══════════════════════════════════════════════════════════════════════════
  # STEP 3: VIDEO - Render Manim animation
  # ═══════════════════════════════════════════════════════════════════════════
  video:
    name: "3 Render Video"
    needs: [detect, script, audio]
    runs-on: ubuntu-latest
    outputs:
      video_hash: ${{ steps.render.outputs.video_hash }}
      input_hash: ${{ steps.render.outputs.input_hash }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Manim
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libcairo2-dev libpango1.0-dev
          pip install manim

      - name: Download audio
        uses: actions/download-artifact@v4
        with:
          name: audio-${{ needs.detect.outputs.reel_id }}
          path: audio/

      - name: Render video
        id: render
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "## Step 3: VIDEO" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **ROLE:** I am the VIDEO RENDERER. I create Manim animations." >> $GITHUB_STEP_SUMMARY
          echo "> **INPUT:** Audio timings from Step 2." >> $GITHUB_STEP_SUMMARY
          echo "> **OUTPUT:** Rendered MP4 video." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify chain
          INPUT_HASH="${{ needs.audio.outputs.audio_hash }}"
          echo "input_hash=$INPUT_HASH" >> $GITHUB_OUTPUT

          echo "### Chain Validation" >> $GITHUB_STEP_SUMMARY
          echo "Input hash: \`${INPUT_HASH:0:16}...\`" >> $GITHUB_STEP_SUMMARY

          # Decode segments for Claude
          echo "${{ needs.script.outputs.segments_json }}" | base64 -d > segments.json

          # Get timings
          echo "${{ needs.audio.outputs.timings_json }}" | base64 -d > audio/timings.json

          SUBJECT="${{ needs.detect.outputs.subject }}"
          REEL_ID="${{ needs.detect.outputs.reel_id }}"

          # Call Claude to generate Manim code
          cat > api_request.json << EOF
          {
            "model": "claude-sonnet-4-20250514",
            "max_tokens": 8000,
            "messages": [{
              "role": "user",
              "content": "Generate a complete Manim reel.py for this JeetLo reel.\n\nSEGMENTS:\n$(cat segments.json)\n\nTIMINGS:\n$(cat audio/timings.json)\n\nSUBJECT: $SUBJECT\n\nREQUIREMENTS:\n- 9:16 vertical format (1080x1920)\n- Use JeetLo brand colors\n- Each segment should have appropriate animations\n- Timing must match audio durations\n- Output ONLY the Python code, no explanation\n\nStart with: from manim import *"
            }]
          }
          EOF

          curl -s -X POST https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d @api_request.json > response.json

          # Extract code
          jq -r '.content[0].text' response.json | grep -v '```' > reel.py

          # Render
          manim render -qh reel.py --format mp4 || {
            echo "Manim render failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          }

          # Find output
          VIDEO_PATH=$(find media -name "*.mp4" | head -1)
          if [ -z "$VIDEO_PATH" ]; then
            echo "No video file found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          VIDEO_HASH=$(sha256sum "$VIDEO_PATH" | cut -d' ' -f1)
          echo "video_hash=$VIDEO_HASH" >> $GITHUB_OUTPUT

          # Copy to known location
          cp "$VIDEO_PATH" video.mp4

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Video Rendered" >> $GITHUB_STEP_SUMMARY
          echo "- **Output Hash:** \`${VIDEO_HASH:0:16}...\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload video artifact
        uses: actions/upload-artifact@v4
        with:
          name: video-${{ needs.detect.outputs.reel_id }}
          path: video.mp4

  # ═══════════════════════════════════════════════════════════════════════════
  # STEP 4: COMBINE - Merge audio and video
  # ═══════════════════════════════════════════════════════════════════════════
  combine:
    name: "4 Combine A/V"
    needs: [detect, audio, video]
    runs-on: ubuntu-latest
    outputs:
      final_hash: ${{ steps.combine.outputs.final_hash }}
      input_hash: ${{ steps.combine.outputs.input_hash }}
    steps:
      - name: Setup
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Combine
        id: combine
        run: |
          echo "## Step 4: COMBINE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **ROLE:** I am the COMBINER. I merge audio and video." >> $GITHUB_STEP_SUMMARY
          echo "> **INPUT:** Video from Step 3, Audio from Step 2." >> $GITHUB_STEP_SUMMARY
          echo "> **OUTPUT:** Final MP4 with synced audio." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          VIDEO_PATH=$(find artifacts -name "video.mp4" | head -1)
          AUDIO_PATH=$(find artifacts -name "combined_audio.mp3" | head -1)

          # Verify chain
          VIDEO_HASH=$(sha256sum "$VIDEO_PATH" | cut -d' ' -f1)
          EXPECTED_VIDEO="${{ needs.video.outputs.video_hash }}"

          echo "### Chain Validation" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "Expected video hash: ${EXPECTED_VIDEO:0:32}..." >> $GITHUB_STEP_SUMMARY
          echo "Actual video hash:   ${VIDEO_HASH:0:32}..." >> $GITHUB_STEP_SUMMARY

          if [ "$VIDEO_HASH" != "$EXPECTED_VIDEO" ]; then
            echo "STATUS: CHAIN BROKEN" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "STATUS: CHAIN VALID" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          INPUT_HASH="$VIDEO_HASH"
          echo "input_hash=$INPUT_HASH" >> $GITHUB_OUTPUT

          # Combine
          ffmpeg -y \
            -i "$VIDEO_PATH" \
            -i "$AUDIO_PATH" \
            -c:v libx264 -preset fast -crf 18 \
            -c:a aac -b:a 192k \
            -shortest \
            final.mp4

          FINAL_HASH=$(sha256sum final.mp4 | cut -d' ' -f1)
          echo "final_hash=$FINAL_HASH" >> $GITHUB_OUTPUT

          # Get duration
          DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 final.mp4)

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Final Video Created" >> $GITHUB_STEP_SUMMARY
          echo "- **Duration:** ${DURATION}s" >> $GITHUB_STEP_SUMMARY
          echo "- **Output Hash:** \`${FINAL_HASH:0:16}...\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload final video
        uses: actions/upload-artifact@v4
        with:
          name: final-${{ needs.detect.outputs.reel_id }}
          path: final.mp4

  # ═══════════════════════════════════════════════════════════════════════════
  # STEP 5: VALIDATE - Run QA checks
  # ═══════════════════════════════════════════════════════════════════════════
  validate:
    name: "5 Validate"
    needs: [detect, script, audio, video, combine]
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.validate.outputs.valid }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg
          pip install -e .

      - name: Download final video
        uses: actions/download-artifact@v4
        with:
          name: final-${{ needs.detect.outputs.reel_id }}
          path: .

      - name: Validate
        id: validate
        run: |
          echo "## Step 5: VALIDATE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **ROLE:** I am the VALIDATOR. I verify the entire chain." >> $GITHUB_STEP_SUMMARY
          echo "> **INPUT:** Final video and all previous hashes." >> $GITHUB_STEP_SUMMARY
          echo "> **OUTPUT:** Validation report." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify chain integrity
          FINAL_HASH=$(sha256sum final.mp4 | cut -d' ' -f1)
          EXPECTED_FINAL="${{ needs.combine.outputs.final_hash }}"

          echo "### Full Chain Audit" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "╔═══════════════════════════════════════════════════════════════╗" >> $GITHUB_STEP_SUMMARY
          echo "║                    COMPLETE CHAIN VERIFICATION                 ║" >> $GITHUB_STEP_SUMMARY
          echo "╠═══════════════════════════════════════════════════════════════╣" >> $GITHUB_STEP_SUMMARY
          echo "║                                                               ║" >> $GITHUB_STEP_SUMMARY
          echo "║  Step 1 SCRIPT  → ${{ needs.script.outputs.output_hash }}  ║" >> $GITHUB_STEP_SUMMARY
          echo "║       ↓                                                       ║" >> $GITHUB_STEP_SUMMARY
          echo "║  Step 2 AUDIO   → ${{ needs.audio.outputs.audio_hash }}    ║" >> $GITHUB_STEP_SUMMARY
          echo "║       ↓                                                       ║" >> $GITHUB_STEP_SUMMARY
          echo "║  Step 3 VIDEO   → ${{ needs.video.outputs.video_hash }}    ║" >> $GITHUB_STEP_SUMMARY
          echo "║       ↓                                                       ║" >> $GITHUB_STEP_SUMMARY
          echo "║  Step 4 COMBINE → ${{ needs.combine.outputs.final_hash }}  ║" >> $GITHUB_STEP_SUMMARY
          echo "║                                                               ║" >> $GITHUB_STEP_SUMMARY

          if [ "$FINAL_HASH" == "$EXPECTED_FINAL" ]; then
            echo "║  STATUS: ✅ CHAIN INTACT                                      ║" >> $GITHUB_STEP_SUMMARY
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "║  STATUS: ❌ CHAIN BROKEN                                      ║" >> $GITHUB_STEP_SUMMARY
            echo "valid=false" >> $GITHUB_OUTPUT
          fi

          echo "║                                                               ║" >> $GITHUB_STEP_SUMMARY
          echo "╚═══════════════════════════════════════════════════════════════╝" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Additional QA checks
          DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 final.mp4)

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quality Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          # Duration check (30-90 seconds)
          if (( $(echo "$DURATION > 30" | bc -l) )) && (( $(echo "$DURATION < 90" | bc -l) )); then
            echo "| Duration (${DURATION}s) | ✅ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Duration (${DURATION}s) | ⚠️ |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "| Chain Integrity | $([[ \"$FINAL_HASH\" == \"$EXPECTED_FINAL\" ]] && echo '✅' || echo '❌') |" >> $GITHUB_STEP_SUMMARY

  # ═══════════════════════════════════════════════════════════════════════════
  # STEP 6: POST - Post to platforms
  # ═══════════════════════════════════════════════════════════════════════════
  post:
    name: "6 Post"
    needs: [detect, validate, combine]
    if: needs.validate.outputs.valid == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download final video
        uses: actions/download-artifact@v4
        with:
          name: final-${{ needs.detect.outputs.reel_id }}
          path: .

      - name: Post to platforms
        run: |
          echo "## Step 6: POST" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **ROLE:** I am the GATEKEEPER. I post only validated content." >> $GITHUB_STEP_SUMMARY
          echo "> **INPUT:** Validated final video." >> $GITHUB_STEP_SUMMARY
          echo "> **OUTPUT:** Post IDs for each platform." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify final hash one more time
          FINAL_HASH=$(sha256sum final.mp4 | cut -d' ' -f1)
          EXPECTED="${{ needs.combine.outputs.final_hash }}"

          if [ "$FINAL_HASH" != "$EXPECTED" ]; then
            echo "## ❌ FINAL HASH MISMATCH - POSTING BLOCKED" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "### Final Gatekeeper Check" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "Final video hash: ${FINAL_HASH:0:32}..." >> $GITHUB_STEP_SUMMARY
          echo "Expected hash:    ${EXPECTED:0:32}..." >> $GITHUB_STEP_SUMMARY
          echo "STATUS: ✅ MATCH - APPROVED FOR POSTING" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # TODO: Actual posting would happen here
          # For now, just mark as ready
          echo "### Posting Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Instagram | Ready to post |" >> $GITHUB_STEP_SUMMARY
          echo "| YouTube | Ready to post |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ✅ REEL CREATION COMPLETE" >> $GITHUB_STEP_SUMMARY

  # ═══════════════════════════════════════════════════════════════════════════
  # SUMMARY
  # ═══════════════════════════════════════════════════════════════════════════
  summary:
    name: "Pipeline Summary"
    needs: [detect, script, audio, video, combine, validate, post]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "# JeetLo Reel Creation Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reel:** \`${{ needs.detect.outputs.reel_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Subject:** \`${{ needs.detect.outputs.subject }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Pipeline Execution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "┌─────────────────────────────────────────────────────────────────┐" >> $GITHUB_STEP_SUMMARY
          echo "│                    JEETLO REEL PIPELINE                         │" >> $GITHUB_STEP_SUMMARY
          echo "├─────────────────────────────────────────────────────────────────┤" >> $GITHUB_STEP_SUMMARY
          echo "│                                                                 │" >> $GITHUB_STEP_SUMMARY
          echo "│  1 SCRIPT   ${{ needs.script.result == 'success' && '✅' || '❌' }}  Write Hinglish segment scripts             │" >> $GITHUB_STEP_SUMMARY
          echo "│       ↓                                                         │" >> $GITHUB_STEP_SUMMARY
          echo "│  2 AUDIO    ${{ needs.audio.result == 'success' && '✅' || '❌' }}  Generate TTS audio files                    │" >> $GITHUB_STEP_SUMMARY
          echo "│       ↓                                                         │" >> $GITHUB_STEP_SUMMARY
          echo "│  3 VIDEO    ${{ needs.video.result == 'success' && '✅' || '❌' }}  Render Manim animation                      │" >> $GITHUB_STEP_SUMMARY
          echo "│       ↓                                                         │" >> $GITHUB_STEP_SUMMARY
          echo "│  4 COMBINE  ${{ needs.combine.result == 'success' && '✅' || '❌' }}  Merge audio + video                        │" >> $GITHUB_STEP_SUMMARY
          echo "│       ↓                                                         │" >> $GITHUB_STEP_SUMMARY
          echo "│  5 VALIDATE ${{ needs.validate.result == 'success' && '✅' || '❌' }}  Verify chain integrity                     │" >> $GITHUB_STEP_SUMMARY
          echo "│       ↓                                                         │" >> $GITHUB_STEP_SUMMARY
          echo "│  6 POST     ${{ needs.post.result == 'success' && '✅' || needs.post.result == 'skipped' && '⏭️' || '❌' }}  Post to Instagram + YouTube                │" >> $GITHUB_STEP_SUMMARY
          echo "│                                                                 │" >> $GITHUB_STEP_SUMMARY
          echo "└─────────────────────────────────────────────────────────────────┘" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.post.result }}" == "success" ]; then
            echo "## ✅ PIPELINE COMPLETE" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.validate.result }}" != "success" ]; then
            echo "## ❌ VALIDATION FAILED - POSTING BLOCKED" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ⚠️ PIPELINE INCOMPLETE" >> $GITHUB_STEP_SUMMARY
          fi
