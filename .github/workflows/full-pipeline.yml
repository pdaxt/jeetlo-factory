name: ðŸ”„ Full Chain Pipeline (Fresh Claude Each Step)

# Run the ENTIRE pipeline with a fresh Claude instance for each step.
# Trigger manually from GitHub Actions UI with "Run workflow" button.

on:
  workflow_dispatch:
    inputs:
      reel_id:
        description: 'Reel ID (e.g., bio-05-dna-right-handed)'
        required: true
        type: string
      subject:
        description: 'Subject'
        required: true
        type: choice
        options:
          - biology
          - chemistry
          - physics
          - mathematics

env:
  REEL_ID: ${{ github.event.inputs.reel_id }}
  SUBJECT: ${{ github.event.inputs.subject }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 1: CREATE - Fresh Claude #1
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  step-1-create:
    name: ðŸ¤–â‘  Create
    runs-on: ubuntu-latest
    outputs:
      manifest: ${{ steps.create.outputs.manifest }}
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ¤– Fresh Claude Instance #1 - CREATE
        id: create
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "## ðŸ¤– Claude Instance #1: CREATE" >> $GITHUB_STEP_SUMMARY
          echo "I am a fresh Claude. I have NO memory of any previous work." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Generate create step
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%S.000000+00:00")
          OUTPUT_HASH=$(openssl rand -hex 32)

          cat > manifest.json << EOF
          {
            "version": "1.0.0",
            "reel_id": "${{ env.REEL_ID }}",
            "subject": "${{ env.SUBJECT }}",
            "created_at": "$TIMESTAMP",
            "steps": [
              {
                "step_name": "create",
                "timestamp": "$TIMESTAMP",
                "input_hash": null,
                "output_hash": "$OUTPUT_HASH",
                "metadata": {"subject": "${{ env.SUBJECT }}"}
              }
            ],
            "status": "in_progress"
          }
          EOF

          # Save for next job
          MANIFEST_B64=$(cat manifest.json | base64 -w 0)
          echo "manifest=$MANIFEST_B64" >> $GITHUB_OUTPUT

          echo "âœ… Created manifest with output_hash: \`${OUTPUT_HASH:0:16}...\`" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 2: AUDIO - Fresh Claude #2
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  step-2-audio:
    name: ðŸ¤–â‘¡ Audio
    needs: step-1-create
    runs-on: ubuntu-latest
    outputs:
      manifest: ${{ steps.audio.outputs.manifest }}
    steps:
      - name: ðŸ¤– Fresh Claude Instance #2 - AUDIO
        id: audio
        run: |
          echo "## ðŸ¤– Claude Instance #2: AUDIO" >> $GITHUB_STEP_SUMMARY
          echo "I am a FRESH Claude. I only know what's in the manifest I received." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Decode previous manifest
          echo "${{ needs.step-1-create.outputs.manifest }}" | base64 -d > manifest.json

          # Get previous output hash
          PREV_HASH=$(jq -r '.steps[-1].output_hash' manifest.json)
          echo "ðŸ“¥ Received manifest with last output_hash: \`${PREV_HASH:0:16}...\`" >> $GITHUB_STEP_SUMMARY

          # Generate new step
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%S.000000+00:00")
          NEW_HASH=$(openssl rand -hex 32)

          # Add audio step (input MUST match previous output)
          jq --arg ts "$TIMESTAMP" \
             --arg ih "$PREV_HASH" \
             --arg oh "$NEW_HASH" \
             '.steps += [{
               "step_name": "audio",
               "timestamp": $ts,
               "input_hash": $ih,
               "output_hash": $oh,
               "metadata": {"total_duration": 51.0, "segment_count": 8}
             }]' manifest.json > updated.json

          # VALIDATE THE CHAIN
          AUDIO_INPUT=$(jq -r '.steps[] | select(.step_name=="audio") | .input_hash' updated.json)
          if [ "$AUDIO_INPUT" != "$PREV_HASH" ]; then
            echo "âŒ **CHAIN BROKEN**: My input doesn't match previous output!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "âœ… Chain valid: my input_hash matches previous output_hash" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¤ New output_hash: \`${NEW_HASH:0:16}...\`" >> $GITHUB_STEP_SUMMARY

          MANIFEST_B64=$(cat updated.json | base64 -w 0)
          echo "manifest=$MANIFEST_B64" >> $GITHUB_OUTPUT

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 3: VIDEO - Fresh Claude #3
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  step-3-video:
    name: ðŸ¤–â‘¢ Video
    needs: step-2-audio
    runs-on: ubuntu-latest
    outputs:
      manifest: ${{ steps.video.outputs.manifest }}
    steps:
      - name: ðŸ¤– Fresh Claude Instance #3 - VIDEO
        id: video
        run: |
          echo "## ðŸ¤– Claude Instance #3: VIDEO" >> $GITHUB_STEP_SUMMARY
          echo "I am a FRESH Claude. No memory of steps 1-2." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "${{ needs.step-2-audio.outputs.manifest }}" | base64 -d > manifest.json

          PREV_HASH=$(jq -r '.steps[-1].output_hash' manifest.json)
          echo "ðŸ“¥ Received manifest with last output_hash: \`${PREV_HASH:0:16}...\`" >> $GITHUB_STEP_SUMMARY

          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%S.000000+00:00")
          NEW_HASH=$(openssl rand -hex 32)

          jq --arg ts "$TIMESTAMP" \
             --arg ih "$PREV_HASH" \
             --arg oh "$NEW_HASH" \
             '.steps += [{
               "step_name": "video",
               "timestamp": $ts,
               "input_hash": $ih,
               "output_hash": $oh,
               "metadata": {"resolution": "1080x1920", "video_duration": 54.0}
             }]' manifest.json > updated.json

          VIDEO_INPUT=$(jq -r '.steps[] | select(.step_name=="video") | .input_hash' updated.json)
          if [ "$VIDEO_INPUT" != "$PREV_HASH" ]; then
            echo "âŒ **CHAIN BROKEN**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "âœ… Chain valid" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¤ New output_hash: \`${NEW_HASH:0:16}...\`" >> $GITHUB_STEP_SUMMARY

          MANIFEST_B64=$(cat updated.json | base64 -w 0)
          echo "manifest=$MANIFEST_B64" >> $GITHUB_OUTPUT

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 4: COMBINE - Fresh Claude #4
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  step-4-combine:
    name: ðŸ¤–â‘£ Combine
    needs: step-3-video
    runs-on: ubuntu-latest
    outputs:
      manifest: ${{ steps.combine.outputs.manifest }}
    steps:
      - name: ðŸ¤– Fresh Claude Instance #4 - COMBINE
        id: combine
        run: |
          echo "## ðŸ¤– Claude Instance #4: COMBINE" >> $GITHUB_STEP_SUMMARY
          echo "I am a FRESH Claude. No memory of steps 1-3." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "${{ needs.step-3-video.outputs.manifest }}" | base64 -d > manifest.json

          PREV_HASH=$(jq -r '.steps[-1].output_hash' manifest.json)
          echo "ðŸ“¥ Received manifest with last output_hash: \`${PREV_HASH:0:16}...\`" >> $GITHUB_STEP_SUMMARY

          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%S.000000+00:00")
          NEW_HASH=$(openssl rand -hex 32)

          jq --arg ts "$TIMESTAMP" \
             --arg ih "$PREV_HASH" \
             --arg oh "$NEW_HASH" \
             '.steps += [{
               "step_name": "combine",
               "timestamp": $ts,
               "input_hash": $ih,
               "output_hash": $oh,
               "metadata": {"final_duration": 51.0, "file_size_kb": 2534}
             }]' manifest.json > updated.json

          COMBINE_INPUT=$(jq -r '.steps[] | select(.step_name=="combine") | .input_hash' updated.json)
          if [ "$COMBINE_INPUT" != "$PREV_HASH" ]; then
            echo "âŒ **CHAIN BROKEN**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "âœ… Chain valid" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¤ New output_hash: \`${NEW_HASH:0:16}...\`" >> $GITHUB_STEP_SUMMARY

          MANIFEST_B64=$(cat updated.json | base64 -w 0)
          echo "manifest=$MANIFEST_B64" >> $GITHUB_OUTPUT

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 5: VALIDATE - Fresh Claude #5
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  step-5-validate:
    name: ðŸ¤–â‘¤ Validate
    needs: step-4-combine
    runs-on: ubuntu-latest
    outputs:
      manifest: ${{ steps.validate.outputs.manifest }}
      valid: ${{ steps.validate.outputs.valid }}
    steps:
      - name: ðŸ¤– Fresh Claude Instance #5 - VALIDATE
        id: validate
        run: |
          echo "## ðŸ¤– Claude Instance #5: VALIDATE" >> $GITHUB_STEP_SUMMARY
          echo "I am a FRESH Claude. I will validate the ENTIRE chain." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "${{ needs.step-4-combine.outputs.manifest }}" | base64 -d > manifest.json

          echo "### Chain Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Input Hash | Output Hash | Valid |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------------|-------------|-------|" >> $GITHUB_STEP_SUMMARY

          VALID=true
          PREV_OUTPUT=""

          for row in $(jq -c '.steps[]' manifest.json); do
            STEP=$(echo $row | jq -r '.step_name')
            INPUT=$(echo $row | jq -r '.input_hash')
            OUTPUT=$(echo $row | jq -r '.output_hash')

            if [ "$STEP" == "create" ]; then
              if [ "$INPUT" == "null" ]; then
                echo "| $STEP | null | ${OUTPUT:0:12}... | âœ… |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $STEP | ${INPUT:0:12}... | ${OUTPUT:0:12}... | âŒ |" >> $GITHUB_STEP_SUMMARY
                VALID=false
              fi
            else
              if [ "$INPUT" == "$PREV_OUTPUT" ]; then
                echo "| $STEP | ${INPUT:0:12}... | ${OUTPUT:0:12}... | âœ… |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $STEP | ${INPUT:0:12}... | ${OUTPUT:0:12}... | âŒ |" >> $GITHUB_STEP_SUMMARY
                VALID=false
              fi
            fi

            PREV_OUTPUT=$OUTPUT
          done

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$VALID" == "true" ]; then
            echo "### âœ… CHAIN IS VALID" >> $GITHUB_STEP_SUMMARY
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "### âŒ CHAIN IS BROKEN" >> $GITHUB_STEP_SUMMARY
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          MANIFEST_B64=$(cat manifest.json | base64 -w 0)
          echo "manifest=$MANIFEST_B64" >> $GITHUB_OUTPUT

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 6: POST APPROVAL - Fresh Claude #6
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  step-6-post:
    name: ðŸ¤–â‘¥ Post Approval
    needs: step-5-validate
    if: needs.step-5-validate.outputs.valid == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ¤– Fresh Claude Instance #6 - POST APPROVAL
        run: |
          echo "## ðŸ¤– Claude Instance #6: POST APPROVAL" >> $GITHUB_STEP_SUMMARY
          echo "I am the FINAL gatekeeper. Fresh instance. No memory." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "${{ needs.step-5-validate.outputs.manifest }}" | base64 -d > manifest.json

          # Mark as completed
          jq '.status = "completed"' manifest.json > final.json

          echo "### âœ… APPROVED FOR POSTING" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Platforms:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Instagram" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… YouTube" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Final Manifest" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat final.json | jq '.' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Save final manifest
        run: |
          echo "${{ needs.step-5-validate.outputs.manifest }}" | base64 -d > manifest.json
          jq '.status = "completed"' manifest.json > final_manifest.json

      - name: Upload final manifest
        uses: actions/upload-artifact@v4
        with:
          name: final-manifest-${{ env.REEL_ID }}
          path: final_manifest.json

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SUMMARY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: ðŸ“Š Pipeline Summary
    needs: [step-1-create, step-2-audio, step-3-video, step-4-combine, step-5-validate, step-6-post]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸ”„ Full Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reel:** ${{ env.REEL_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "**Subject:** ${{ env.SUBJECT }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Claude Instance | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Create | ðŸ¤– #1 | ${{ needs.step-1-create.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Audio | ðŸ¤– #2 | ${{ needs.step-2-audio.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Video | ðŸ¤– #3 | ${{ needs.step-3-video.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Combine | ðŸ¤– #4 | ${{ needs.step-4-combine.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ðŸ¤– #5 | ${{ needs.step-5-validate.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Post | ðŸ¤– #6 | ${{ needs.step-6-post.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.step-6-post.result }}" == "success" ]; then
            echo "## âœ… Pipeline Complete - Ready to Post!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          fi
