name: Validate Reels

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual triggers

jobs:
  validate:
    runs-on: ubuntu-latest
    name: ðŸ”— Chain Validation

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install dependencies
        run: |
          pip install -e .

      - name: ðŸ” Find manifests
        id: find
        run: |
          count=$(find . -name ".jeetlo_manifest.json" | wc -l)
          echo "count=$count" >> $GITHUB_OUTPUT
          echo "### ðŸ“ Found $count manifest(s)" >> $GITHUB_STEP_SUMMARY

      - name: âœ… Validate chain integrity
        if: steps.find.outputs.count != '0'
        run: |
          # Run chain-only validation (doesn't require media files)
          python -m jeetlo_factory.ci . --chain-only 2>&1 | tee validation.log

          # Check result
          if grep -q "CI PASSED" validation.log; then
            echo "### âœ… All chains valid!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Chain validation failed!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: ðŸ“Š Generate badge data
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "BADGE_COLOR=brightgreen" >> $GITHUB_ENV
            echo "BADGE_STATUS=passing" >> $GITHUB_ENV
          else
            echo "BADGE_COLOR=red" >> $GITHUB_ENV
            echo "BADGE_STATUS=failing" >> $GITHUB_ENV
          fi

      - name: ðŸ“ No manifests found
        if: steps.find.outputs.count == '0'
        run: |
          echo "### â„¹ï¸ No manifests to validate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Push a reel with \`.jeetlo_manifest.json\` to trigger validation." >> $GITHUB_STEP_SUMMARY
