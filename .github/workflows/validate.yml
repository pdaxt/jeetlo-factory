name: ðŸ”— Proof Chain Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 1: DISCOVER - Find all manifests
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  discover:
    name: ðŸ“ Discover Reels
    runs-on: ubuntu-latest
    outputs:
      manifests: ${{ steps.find.outputs.manifests }}
      count: ${{ steps.find.outputs.count }}
    steps:
      - uses: actions/checkout@v4

      - name: Find manifests
        id: find
        run: |
          # Find all manifest files and create JSON array
          manifests=$(find . -name ".jeetlo_manifest.json" -type f | jq -R -s -c 'split("\n") | map(select(length > 0))')
          count=$(echo $manifests | jq 'length')
          echo "manifests=$manifests" >> $GITHUB_OUTPUT
          echo "count=$count" >> $GITHUB_OUTPUT
          echo "### ðŸ“ Found $count manifest(s)" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 2: VALIDATE CREATE - Check reel was created properly
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate-create:
    name: 1ï¸âƒ£ Create Step
    needs: discover
    if: needs.discover.outputs.count != '0'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate CREATE step
        run: |
          echo "## 1ï¸âƒ£ Validating CREATE Step" >> $GITHUB_STEP_SUMMARY

          failed=0
          for manifest in $(find . -name ".jeetlo_manifest.json"); do
            reel_id=$(jq -r '.reel_id' "$manifest")

            # Check create step exists
            has_create=$(jq '.steps[] | select(.step_name == "create")' "$manifest")
            if [ -n "$has_create" ]; then
              # Check first step has null input_hash
              first_input=$(jq -r '.steps[0].input_hash' "$manifest")
              if [ "$first_input" == "null" ]; then
                echo "âœ… **$reel_id**: Create step valid" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ **$reel_id**: First step must have null input_hash" >> $GITHUB_STEP_SUMMARY
                failed=1
              fi
            else
              echo "âŒ **$reel_id**: Missing CREATE step" >> $GITHUB_STEP_SUMMARY
              failed=1
            fi
          done

          exit $failed

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 3: VALIDATE AUDIO - Check audio generation chain
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate-audio:
    name: 2ï¸âƒ£ Audio Step
    needs: validate-create
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate AUDIO step chain
        run: |
          echo "## 2ï¸âƒ£ Validating AUDIO Step" >> $GITHUB_STEP_SUMMARY

          failed=0
          for manifest in $(find . -name ".jeetlo_manifest.json"); do
            reel_id=$(jq -r '.reel_id' "$manifest")

            # Check audio step exists
            has_audio=$(jq '.steps[] | select(.step_name == "audio")' "$manifest")
            if [ -n "$has_audio" ]; then
              # Verify chain: audio.input_hash == create.output_hash
              create_output=$(jq -r '.steps[] | select(.step_name == "create") | .output_hash' "$manifest")
              audio_input=$(jq -r '.steps[] | select(.step_name == "audio") | .input_hash' "$manifest")

              if [ "$create_output" == "$audio_input" ]; then
                duration=$(jq -r '.steps[] | select(.step_name == "audio") | .metadata.total_duration // "?"' "$manifest")
                echo "âœ… **$reel_id**: Audio chain valid (${duration}s)" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ **$reel_id**: Audio input_hash doesn't match create output_hash" >> $GITHUB_STEP_SUMMARY
                failed=1
              fi
            else
              echo "âš ï¸ **$reel_id**: No audio step yet" >> $GITHUB_STEP_SUMMARY
            fi
          done

          exit $failed

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 4: VALIDATE VIDEO - Check video render chain
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate-video:
    name: 3ï¸âƒ£ Video Step
    needs: validate-audio
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate VIDEO step chain
        run: |
          echo "## 3ï¸âƒ£ Validating VIDEO Step" >> $GITHUB_STEP_SUMMARY

          failed=0
          for manifest in $(find . -name ".jeetlo_manifest.json"); do
            reel_id=$(jq -r '.reel_id' "$manifest")

            # Check video step exists
            has_video=$(jq '.steps[] | select(.step_name == "video")' "$manifest")
            if [ -n "$has_video" ]; then
              # Verify chain: video.input_hash == audio.output_hash
              audio_output=$(jq -r '.steps[] | select(.step_name == "audio") | .output_hash' "$manifest")
              video_input=$(jq -r '.steps[] | select(.step_name == "video") | .input_hash' "$manifest")

              if [ "$audio_output" == "$video_input" ]; then
                resolution=$(jq -r '.steps[] | select(.step_name == "video") | .metadata.resolution // "?"' "$manifest")
                echo "âœ… **$reel_id**: Video chain valid ($resolution)" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ **$reel_id**: Video input_hash doesn't match audio output_hash" >> $GITHUB_STEP_SUMMARY
                failed=1
              fi
            else
              echo "âš ï¸ **$reel_id**: No video step yet" >> $GITHUB_STEP_SUMMARY
            fi
          done

          exit $failed

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 5: VALIDATE COMBINE - Check final combination
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate-combine:
    name: 4ï¸âƒ£ Combine Step
    needs: validate-video
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate COMBINE step chain
        run: |
          echo "## 4ï¸âƒ£ Validating COMBINE Step" >> $GITHUB_STEP_SUMMARY

          failed=0
          for manifest in $(find . -name ".jeetlo_manifest.json"); do
            reel_id=$(jq -r '.reel_id' "$manifest")

            # Check combine step exists
            has_combine=$(jq '.steps[] | select(.step_name == "combine")' "$manifest")
            if [ -n "$has_combine" ]; then
              # Verify chain: combine.input_hash == video.output_hash
              video_output=$(jq -r '.steps[] | select(.step_name == "video") | .output_hash' "$manifest")
              combine_input=$(jq -r '.steps[] | select(.step_name == "combine") | .input_hash' "$manifest")

              if [ "$video_output" == "$combine_input" ]; then
                duration=$(jq -r '.steps[] | select(.step_name == "combine") | .metadata.final_duration // "?"' "$manifest")
                echo "âœ… **$reel_id**: Combine chain valid (${duration}s final)" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ **$reel_id**: Combine input_hash doesn't match video output_hash" >> $GITHUB_STEP_SUMMARY
                failed=1
              fi
            else
              echo "âš ï¸ **$reel_id**: No combine step yet" >> $GITHUB_STEP_SUMMARY
            fi
          done

          exit $failed

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 6: VALIDATE POST - Check posting status
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate-post:
    name: 5ï¸âƒ£ Post Step
    needs: validate-combine
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate POST step
        run: |
          echo "## 5ï¸âƒ£ Validating POST Step" >> $GITHUB_STEP_SUMMARY

          for manifest in $(find . -name ".jeetlo_manifest.json"); do
            reel_id=$(jq -r '.reel_id' "$manifest")
            status=$(jq -r '.status' "$manifest")

            # Check post step exists
            has_post=$(jq '.steps[] | select(.step_name == "post")' "$manifest")
            if [ -n "$has_post" ]; then
              # Get platform statuses
              instagram=$(jq -r '.steps[] | select(.step_name == "post") | .metadata.platforms.instagram.status // "not posted"' "$manifest")
              youtube=$(jq -r '.steps[] | select(.step_name == "post") | .metadata.platforms.youtube.status // "not posted"' "$manifest")

              echo "âœ… **$reel_id**: Posted" >> $GITHUB_STEP_SUMMARY
              echo "   - Instagram: $instagram" >> $GITHUB_STEP_SUMMARY
              echo "   - YouTube: $youtube" >> $GITHUB_STEP_SUMMARY
            else
              if [ "$status" == "completed" ]; then
                echo "âš ï¸ **$reel_id**: Status is 'completed' but no post step" >> $GITHUB_STEP_SUMMARY
              else
                echo "â„¹ï¸ **$reel_id**: Not yet posted (status: $status)" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # FINAL: SUMMARY - Overall chain status
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: ðŸ“Š Chain Summary
    needs: [validate-create, validate-audio, validate-video, validate-combine, validate-post]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate summary
        run: |
          echo "# ðŸ”— Proof Chain Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check each job status
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1ï¸âƒ£ Create | ${{ needs.validate-create.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2ï¸âƒ£ Audio | ${{ needs.validate-audio.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3ï¸âƒ£ Video | ${{ needs.validate-video.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 4ï¸âƒ£ Combine | ${{ needs.validate-combine.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 5ï¸âƒ£ Post | ${{ needs.validate-post.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [ "${{ needs.validate-combine.result }}" == "success" ]; then
            echo "## âœ… Chain Valid - Ready to Post!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Chain Broken - Cannot Post" >> $GITHUB_STEP_SUMMARY
          fi
